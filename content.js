var WordList = "	a	AA	AAH 	AAHP 	AAHSA 	AAHSA 	Aberdeen	Abilene	AC	Adams	AHA  	AK	Akron	AL	Alabama	Alaska	Albany	Albuquerque	Alexandria	all	Allen	Allentown	Amarillo	amid	an	ANA	Anaheim	Anchorage	and	Anderson	Ann Arbor	Anthony	Antioch	Apple Valley	Appleton	AR	Arizona	Arkansas	Arlington	Arvada	as	Asheville	ASL  	at	Athens	Atlanta	Atlantic City	atop	Augusta	Aurora	Austin	Ave	Ave.	AZ	Baker	Bakersfield	Baltimore	Barbara	Barnstable	Baton Rouge	BBB	Beaumont	Bel Air	Bellevue	Berkeley	Bethlehem	Betty	Billings	Birmingham	Bloomington	Blvd	Blvd.	Boise	Boise City	Bonita Springs	Boston	Boulder	Bradenton	Bremerton	Brian	Bridgeport	Brighton	Brownsville	Bryan	Buffalo	Burbank	Burlington	but	by	CA	California	Cambridge	Campbell	Canton	Cape Coral	Carol	Carrollton	Carter	Cary	Cathedral City	Cedar Rapids	CEO	Champaign	Chandler	Charles	Charleston	Charlotte	Chattanooga	Chesapeake	Chicago	Christopher	Chula Vista	Cincinnati	Clark	Clarke County	Clarksville	Clearwater	Cleveland	CNA  	College Station	Collins	Colorado	Colorado Springs	Columbia	Columbus	Concord	Connecticut	Coral Springs	Corona	Corpus Christi	Costa Mesa	CST	Cswy	CT	Dallas	Daly City	Danbury	Daniel	Davenport	David	Davidson County	Davis	Dayton	Daytona Beach	DC	DE	Deborah	Delaware	Deltona	Denton	Denver	Des Moines	Detroit	District of Columbia	DJ	DoE	DOH	DoJ	DOL	Donald	Donna	Dorothy	down	Downey	Duluth	Durham	Edward	Edwards	El Monte	El Paso	Elizabeth	Elizabeth	Elk Grove	Elkhart	Erie	Escondido	EST	EU	Eugene	Evans	Evansville	Fairfield	Fargo	Fayetteville	FCC	FDA	Fitchburg	FL	Flint	Florida	Fontana	for	Fort Collins	Fort Lauderdale	Fort Smith	Fort Walton Beach	Fort Wayne	Fort Worth	Frederick	Fremont	Fresno	from	Fullerton	GA	Gainesville	Garcia	Garden Grove	Garland	Gastonia	George	Georgia	Gilbert	Glendale	Gonzalez	Grand Prairie	Grand Rapids	Grayslake	Green Bay	GreenBay	Greensboro	Greenville	Guam	Gulfport-Biloxi	Hagerstown	Hall	Hampton	Harlingen	Harris	Harrisburg	Hartford	Havre de Grace	Hawaii	Hayward	Helen	Hemet	Henderson	Hernandez	Hesperia	Hialeah	Hickory	High Point	Hollywood	Honolulu	Houma	Houston	Howell	Huntington	Huntington Beach	Huntsville	HVAC	Hwy	Hwy.	I	IA	Idaho	IL	Illinois	in	Inc	Inc.	Independence	Indiana	Indianapolis	Inglewood	into	Iowa	iPad	iPhone	iPod	Irvine	Irving	Jackson	Jackson	Jacksonville	James	Jason	Jeff	Jefferson	Jennifer	Jersey City	John	Johnson	Johnson City	Joliet	Jones	Joseph	Kailua	Kalamazoo	Kaneohe	Kansas	Kansas City	Karen	Kenneth	Kennewick	Kenosha	Kentucky	Kevin	Killeen	Kimberly	Kissimmee	Knoxville	KS	KY	LA	Lacey	Lafayette	Lake Charles	Lakeland	Lakewood	LAN 	Lancaster	Lansing	Laredo	Las Cruces	Las Vegas	Laura	Layton	Lee	Leominster	lest	Lewis	Lewisville	Lexington	Lincoln	Linda	Lisa	Little Rock	LLC	Long Beach	Lopez	Lorain	Los Angeles	Louisiana	Louisville	Lowell	Lubbock	MacBook	Macon	Madison	Maine	Manchester	Margaret	Maria	Marina	Martin	Martinez	Mary	Maryland	Marysville	Massachusetts	McAllen	McHenry	MD	Medford	Melbourne	Memphis	Merced	Mesa	Mesquite	MI	Miami	Michael	Michelle	Michigan	mid	Miller	Milwaukee	Minneapolis	Minnesota	Miramar	Mission Viejo	Mississippi	Missouri	Mitchell	MN	MO	Modesto	Monroe	Montana	Monterey	Montgomery	Moore	Moreno Valley	MS	MST	MT	Murfreesboro	Murrieta	Muskegon	Myrtle Beach	Nancy	Naperville	Naples	Nashua	Nashville	NC	ND	NE	near	Nebraska	Nelson	Nevada	New Bedford	New Hampshire	New Haven	New Jersey	New London	New Mexico	New Orleans	New York	New York	New York City	Newark	Newburgh	Newport News	next	NH	NIH 	NIMH	NJ	NM	Norfolk	Norman	North Carolina	North Charleston	North Dakota	North Las Vegas	North Port	Northern Marianas Islands	Norwalk	Norwich	NV	NY	NYC	NYC	Oakland	Ocala	Oceanside	Odessa	of	off	Ogden	Ohio	Oklahoma	Oklahoma City	Olathe	Olympia	Omaha	on	Ontario	onto	Orange	Oregon	Orem	Orlando	OT	out	over	Overland Park	Oxnard	PA	Palm Bay	Palm Springs	Palmdale	Panama City	Parker	Pasadena	Paterson	Patricia	Paul	Pembroke Pines	Pennsylvania	Pensacola	Peoria	per	Perez	Philadelphia	Phillips	Phoenix	Pittsburgh	Plano	plus	Pomona	Pompano Beach	Port Arthur	Port Orange	Port Saint Lucie	Port St. lucie	Portland	Portsmouth	Poughkeepsie	pro	Providence	Provo	PT	Pueblo	Puerto Rico	Punta Gorda	Racine	Raleigh	Rancho Cucamonga	Rd	Rd.	Redding	Reno	Rhode Island	RI	Richard	Richland	Richmond	Richmond County	Riverside	Roanoke	Robert	Roberts	Robinson	Rochester	Rockford	Rodriguez	Ronald	Roseville	Round Lake Beach	Ruth	Sacramento	Saginaw	Saint Louis	Saint Louis	Saint Paul	Saint Paul	Saint Petersburg	Saint Petersburg	Salem	Salinas	Salt Lake City	San Antonio	San Bernardino	San Buenaventura	San Diego	San Francisco	San Jose	Sandra	Santa Ana	Santa Barbara	Santa Clara	Santa Clarita	Santa Cruz	Santa Maria	Santa Rosa	Sarah	Sarasota	Savannah	SC	Scott	Scottsdale	Scranton	SD	Seaside	Seattle	Sebastian	Sharon	Shreveport	Simi Valley	Sioux City	Sioux Falls	Smith	South Bend	South Carolina	South Dakota	South Lyon	Spartanburg	Spokane	Springdale	Springfield	Sq	Sq.	St Louis	St Paul	St Petersburg	St. Louis	St. Paul	St. Petersburg	Stamford	Sterling Heights	Steven	Stockton	Sunnyvale	Susan	Syracuse	Tacoma	Tallahassee	Tampa	Taylor	Temecula	Tempe	Tennessee	Texas	than	the	Thomas	Thomas	Thompson	Thornton	Thousand Oaks	till	TN	to	Toledo	Topeka	Torrance	Trenton	Tucson	Tulsa	Turner	Tuscaloosa	TX	Tyler	up	upon	UT	Utah	Utica	VA	Vallejo	Vancouver	Vermont	Vero Beach	via	Victorville	Virgin Islands	Virginia	Virginia Beach	Visalia	vs	vs.	VT	WA	Waco	Walker	Warren	Washington	Washington	Waterbury	Waterloo	West Covina	West Valley City	West Virginia	Westminster	WI	Wichita	William	Williams	Wilmington	Wilson	Winston	Winter Haven	Wisconsin	with	Worcester	Wright	WV	WY	Wyoming	Yakima	Yonkers	York	Youngstown	your	";

String.prototype.toProperCase = function () {
    return this.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
};

String.prototype.toSentenceCase = function () {
    return this.replace(/(^\w|[.!?]\s*\w)/g, function(txt){ return txt.substr(0, txt.length-1) + txt.charAt(txt.length-1).toUpperCase(); });
};

var rClickElm = null;
var cache = {};

if (document.documentElement instanceof HTMLElement) {
	document.addEventListener('contextmenu',
		function(e) {
			rClickElm = e.target;
		}
		, true);
}

chrome.extension.onMessage.addListener(
	function(request, sender, sendResponse) {
		switch (request.type) {
			case "onCaseItCM":
				switch (rClickElm.type) {
					case "text":
					case "textarea":
						var selStart = rClickElm.selectionStart;
						var selEnd = rClickElm.selectionEnd;
						var strValue = replaceText(request.tocase, rClickElm.value.substr(selStart, selEnd-selStart));
						document.execCommand("insertText", false, strValue);
						rClickElm.selectionStart = selStart;
						if (request.tocase != "bullets")
							rClickElm.selectionEnd = selEnd;
						break;
						
					default:
						alert('Please ask developer to handle rClickElm.tagName = ' + rClickElm.tagName);
						break;
				}
				break;
		}
});

function replaceText(tocase, text) {
	switch (tocase) {
		case "sentence" :
			var ret = text.replace(/\b[A-Z]+\b/g, function(txt){ return txt.toLowerCase(); });
			ret = getFixedCaseUpdate(ret);
			ret = ret.toSentenceCase();
			ret = getFixedCaseDotUpdate(ret);
			
			return ret;
			break;
			
		case "proper" :
			var ret = text.replace(/\b[A-Z]+\b/g, function(txt){ return txt.toLowerCase(); }).toProperCase();
			ret = getFixedCaseUpdate(ret);
			ret = getFixedCaseDotUpdate(ret);
			return ret.replace(/\s\w+$/, function(txt){ return txt.substr(0, 2).toUpperCase() + txt.substr(2); });
			break;
			
		case "bullets" :
			var words = text.split(',');
			if (words[words.length-1].indexOf(' and ') > 0) {
				words.push(words[words.length-1].split(' and ')[1]);
				words[words.length-2] = words[words.length-2].substr(0, words[words.length-2].indexOf(' and '));
			}
			for (var i=0; i<words.length; i++)
				words[i] = replaceText("sentence", words[i].trim());
			return "* " + words.join("\n* ");
			break;
	}
}


function getFixedCaseUpdate(val) {
	var ret = val;
	var words = ret.match(/\w+/g);
	var len = words.length;
	var exp = '\\t\\b$WORD$\\b\\t';	
	cache = {};

	//main
	for (var i=0; i<len; i++) {
		var word = null;
		var expArray = null;
		var wordLen = 3;
		
		if (i < (len-2))
			word = words[i] + ' ' + words[i+1] + ' ' + words[i+2];
		
		if (word == null && i < (len-1)) {
			word = words[i] + ' ' + words[i+1];
			wordLen = 2;
		}
			
		if (word == null) {
			word = words[i];
			wordLen = 1;
		}
		
		expArray = getExpArray(word, exp);
		
		if (expArray == "N/A") {
			i += (wordLen-1);
		} else {
			if (expArray == null && wordLen == 3) {
				word = words[i] + ' ' + words[i+1];
				wordLen = 2;
				expArray = getExpArray(word, exp);
			}
			
			if (expArray == "N/A") {
				i += (wordLen-1);
			} else {
				if (expArray == null && wordLen == 2) {
					word = words[i];
					wordLen = 1;
					expArray = getExpArray(word, exp);
				}
			
				if (expArray == "N/A") {
					i += (wordLen-1);
				} else {
					if (expArray != null) {
						var repExp = new RegExp('\\b' + word + '\\b', 'gi');
						ret = ret.replace(repExp, expArray[0].substring(1, expArray[0].length-1));
						i += (wordLen-1);
					}
				}
			}
		}
	}
	
	return ret;
}


function getFixedCaseDotUpdate(val) {
	var ret = val;
	var words = ret.match(/\w+[.]*/g);			
	var len = words.length;
	var exp = '\\t\\b$WORD$\\b\\t';
	var exp2 = '\\t\\b$WORD$\\b[.]\\t';
	cache = {};

	for (var i=0; i<len; i++) {
		var word = null;
		var expArray = null;
		var wordLen = 3;

		if (i < (len-2))
			word = words[i] + ' ' + words[i+1] + ' ' + words[i+2];
		
		if (word == null && i < (len-1)) {
			word = words[i] + ' ' + words[i+1];
			wordLen = 2;
		}
			
		if (word == null) {
			word = words[i];
			wordLen = 1;
		}
		
		if (word.indexOf('.') > 0) {
			if (wordLen == 1)
				expArray = getExpArray(word.replace('.',''), exp2);
			else
				expArray = getExpArray(word, exp);
			
			if (expArray == "N/A") {
				i += (wordLen-1);
			} else {
				
				if (expArray == null && wordLen == 3) {
					word = words[i] + ' ' + words[i+1];
					wordLen = 2;
					expArray = getExpArray(word, exp);
				}
				
				if (word.indexOf('.') > 0) {						
					if (expArray == "N/A") {
						i += (wordLen-1);
					} else {
						if (expArray == null && wordLen == 2) {
							word = words[i];
							wordLen = 1;
							expArray = getExpArray(word, exp);
						}
						
						if (wordLen == 1 && expArray == null)
							expArray = getExpArray(word.replace('.',''), exp2);
					
						if (expArray == "N/A") {
							i += (wordLen-1);
						} else {
							if (expArray != null) {
								if (wordLen == 1) {
									var repExp = new RegExp('\\b' + word.replace('.','') + '\\b[.]\\s*\\w', 'gi');
									ret = ret.replace(repExp, function(txt){ return txt.substr(0, txt.length-1) + txt.charAt(txt.length-1).toLowerCase(); });
								} else {								
									var repExp = new RegExp('\\b' + word + '\\b', 'gi');
									ret = ret.replace(repExp, expArray[0].substring(1, expArray[0].length-1));
								}
								i += (wordLen-1);
							}
						}
					}
				}
			}
		}
	}
	
	return ret;
}


function getExpArray(word, exp) {
	if (!(word in cache)) {
		var ret = (new RegExp(exp.replace('$WORD$', word), 'i')).exec(WordList);
		if (ret == null)
			cache[word+exp] = false;
		else
			cache[word+exp] = true;
		return ret;
	} else
		return "N/A";
}